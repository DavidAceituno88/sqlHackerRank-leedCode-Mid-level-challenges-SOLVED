/*FIRST WE SELECT ALL THE START DATES THAT ARE NOT PRESENT
IN THE END DATE. THAT MEANS THAT THOSE DATES ARE THE START DATES OF A PROJECT 
AND WE GIVE IT A RANK NUMBER*/
WITH CTE1 AS (
SELECT START_DATE , RANK() OVER(ORDER BY START_DATE) AS RANK_START_DATE
FROM PROJECTS 
WHERE START_DATE NOT IN (SELECT END_DATE FROM PROJECTS)),
/*THEN WE SELECT ALL THE END DATES THAT ARE NOT PRESENT 
IN THE START DATE. FOR THE SAME REASONS PREVIOUSLY EXPLAINED*/    
    CTE2 AS(
    SELECT END_DATE, RANK() OVER(ORDER BY END_DATE) AS RANK_END_DATE
        FROM PROJECTS
        WHERE END_DATE NOT IN(SELECT START_DATE FROM PROJECTS))
/*FINALLY WE JOIN BOTH TEMP TABLES BY THEIR RANK NUMBER 
ORDER THE RECORDS BY THE DATEDIFF AND START DATE*/
SELECT START_DATE, END_DATE
        FROM CTE1, CTE2
        WHERE RANK_START_DATE = RANK_END_DATE
        ORDER BY DATEDIFF(day,start_date,end_date), start_date
