WITH CTE AS(
SELECT u.name as name, COUNT(m.rating) as cntrating
FROM Users u
JOIN MovieRating m
ON u.user_id = m.user_id
GROUP BY u.name
),
CTE2 AS(
  SELECT title,AVG(CAST( mr.rating AS DECIMAL(10,2))) AS avgrating
  FROM Movies m
  JOIN MovieRating mr
  ON m.movie_id = mr.movie_id
  WHERE MONTH(created_at) = 02
  GROUP BY title
)
SELECT TOP 1 title AS results
FROM CTE2
WHERE avgrating =(SELECT MAX(avgrating) FROM CTE2)
UNION ALL
SELECT TOP 1 name
FROM CTE 
WHERE cntrating = (SELECT MAX(cntrating) FROM CTE)












WITH CTE AS (
  SELECT COUNT(m.user_id) OVER(PARTITION BY u.name) AS id, u.name AS name 
  FROM movierating m 
  JOIN Users u
  ON m.user_id = u.user_id 
),
CTE2 AS (
  SELECT AVG(CAST(r.rating AS DECIMAL (7,2))) OVER(PARTITION BY r.movie_id, m.title) AS rating, m.title AS title
  FROM movierating r
  JOIN movies m ON r.movie_id = m.movie_id
  WHERE MONTH(r.created_at) = 02  
)
SELECT TOP 1 c1.name AS results
FROM CTE c1
WHERE id = (SELECT MAX(id) FROM CTE)
UNION ALL
SELECT TOP 1 c2.title
FROM CTE2 c2
WHERE c2.rating = (SELECT MAX(rating) FROM CTE2)
