/*SELECT THE LAST DATE*/
WITH CTE AS(
SELECT TOP 1 visited_on AS last_visit
FROM Customer
ORDER BY visited_on DESC
)
SELECT DISTINCT DATEADD(DAY,6,visited_on) as visited_on, 
(
  SELECT SUM(amount)
  FROM Customer c2
  WHERE
  c2.visited_on BETWEEN c1.visited_on AND DATEADD(DAY,6,c1.visited_on) 
 ) AS amount,
 (
  SELECT ROUND((SUM(CAST(amount AS NUMERIC(10,2)))/7),2)
  FROM Customer c2
  WHERE
  c2.visited_on BETWEEN c1.visited_on AND DATEADD(DAY,6,c1.visited_on) 
 ) AS average_amount
FROM Customer c1
WHERE DATEDIFF(DAY,visited_on,(SELECT last_visit FROM CTE))>=6









----------------------------------
/*get the average of the next 6 days*/
WITH CTE AS(
SELECT visited_on, CAST(SUM(amount) AS DECIMAL(7,2)) AS amount, dense_rank() over(order by visited_on) AS rnk
FROM customer
GROUP BY visited_on
),
CTE2 AS(
SELECT rnk,visited_on, 
sum(amount) OVER(ORDER BY visited_on, visited_on ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS amount,
AVG(amount) OVER(ORDER BY visited_on, visited_on ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS average_amount
FROM CTE
)
SELECT visited_on,amount,CAST(average_amount AS DECIMAL(10,2)) AS average_amount
FROM CTE2
ORDER BY visited_on
OFFSET 6 ROWS
